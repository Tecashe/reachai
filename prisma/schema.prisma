generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  name      String?
  firstName String?
  lastName  String?
  imageUrl  String?
  role      UserRole @default(USER)

  // Subscription
  subscriptionTier   SubscriptionTier   @default(FREE)
  subscriptionId     String?
  customerId         String?
  subscriptionStatus SubscriptionStatus @default(INACTIVE)
  currentPeriodEnd   DateTime?

  emailCredits    Int @default(100)
  researchCredits Int @default(50)

  // Usage tracking
  emailsSentThisMonth Int @default(0)
  prospectsThisMonth  Int @default(0)
  aiCreditsUsed       Int @default(0)

  // Onboarding questionnaire
  companyName                      String?
  userRole                         String? // "founder", "sales", "marketing", "other"
  useCase                          String? // "finding_customers", "partnerships", "recruiting", "other"
  monthlyVolume                    String? // "under_500", "500_2000", "over_2000"
  onboardingCompletedQuestionnaire Boolean @default(false)

  // Onboarding progress
  hasCreatedCampaign      Boolean   @default(false)
  hasAddedProspects       Boolean   @default(false)
  hasResearchedProspects  Boolean   @default(false)
  hasGeneratedEmail       Boolean   @default(false)
  hasSentEmail            Boolean   @default(false)
  hasViewedAnalytics      Boolean   @default(false)
  onboardingCompletedAt   DateTime?
  lastOnboardingEmailSent DateTime?
  onboardingEmailsSent    Int       @default(0)

  // Settings
  timezone         String  @default("America/New_York")
  emailSignature   String?
  defaultFromName  String?
  defaultFromEmail String?

  preferences Json? // { scrapingMode: "FAST" | "DEEP", ... }

  subscription    Subscription?
  sendingAccounts SendingAccount[]
  prospectFolders ProspectFolder[]

  // Relationships
  campaigns          Campaign[]
  prospects          Prospect[]
  emailTemplates     EmailTemplate[]
  integrations       Integration[]
  auditLogs          AuditLog[]
  teamMembers        TeamMember[]
  notifications      Notification[]
  apiKeys            ApiKey[]
  creditTransactions CreditTransaction[]
  creditPurchases    CreditPurchase[]
  domains            Domain[]

  // Last time we sent low credit warning
  lastCreditWarning DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clerkId])
  @@index([email])
}

model Subscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  stripeCustomerId       String   @unique
  stripeSubscriptionId   String   @unique
  stripePriceId          String
  stripeCurrentPeriodEnd DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Campaign {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?
  status      CampaignStatus @default(DRAFT)

  wizardStep           String @default("prospects") // "prospects", "research", "generate", "review", "launch"
  wizardData           Json? // Store step-specific progress data
  wizardCompletedSteps Json? // Array of completed step IDs

  // Campaign settings
  dailySendLimit  Int     @default(50)
  sendingSchedule Json? // { days: [], startTime: "", endTime: "" }
  trackOpens      Boolean @default(true)
  trackClicks     Boolean @default(true)

  sequenceAutomationRules SequenceAutomationRule[]

  // AI settings
  researchDepth        ResearchDepth        @default(STANDARD)
  personalizationLevel PersonalizationLevel @default(MEDIUM)
  toneOfVoice          String               @default("professional")

  automationRules Json?

  // Stats
  totalProspects  Int @default(0)
  emailsSent      Int @default(0)
  emailsDelivered Int @default(0)
  emailsOpened    Int @default(0)
  emailsClicked   Int @default(0)
  emailsReplied   Int @default(0)
  emailsBounced   Int @default(0)

  // Relationships
  prospects           Prospect[]
  emailSequences      EmailSequence[]
  analytics           Analytics[]
  replies             EmailReply[]
  subsequenceTriggers SubsequenceTrigger[]

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  launchedAt DateTime?

  @@index([userId])
  @@index([status])
}

model Prospect {
  id         String    @id @default(cuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  folderId String?
  folder   ProspectFolder? @relation("ProspectToFolder", fields: [folderId], references: [id], onDelete: SetNull)

  // Basic info
  email       String
  firstName   String?
  lastName    String?
  company     String?
  jobTitle    String?
  linkedinUrl String?
  websiteUrl  String?

  // Enriched data
  companySize String?
  industry    String?
  location    String?
  phoneNumber String?

  // AI research data
  researchData          Json? // Scraped data, insights, talking points
  qualityScore          Int? // 0-100
  personalizationTokens Json? // Key-value pairs for template variables

  generatedEmail Json? // { subject: string, body: string, qualityScore: number, personalizationScore: number }

  // Email status
  status          ProspectStatus @default(ACTIVE)
  currentStep     Int            @default(0)
  lastContactedAt DateTime?

  // Engagement - detailed tracking
  emailsReceived Int       @default(0) // Total emails sent to this prospect
  emailsOpened   Int       @default(0) // Total times emails were opened
  emailsClicked  Int       @default(0) // Total times links were clicked
  emailsReplied  Int       @default(0) // Total replies received
  replied        Boolean   @default(false) // Has replied at least once
  repliedAt      DateTime?
  bounced        Boolean   @default(false)
  unsubscribed   Boolean   @default(false)

  crmId       String? // External CRM ID (HubSpot, Salesforce, etc.)
  crmType     String? // Type of CRM (hubspot, salesforce, pipedrive)
  crmSyncedAt DateTime? // Last sync timestamp
  crmData     Json? // Raw CRM data
  dealId      String? // Associated deal ID in CRM
  dealScore   Float? // AI deal score 0-100

  // Relationships
  emailLogs        EmailLog[]
  sendingSchedules SendingSchedule[]
  replies          EmailReply[]
  folders          ProspectInFolder[]

  timezone           String?
  timezoneDetectedAt DateTime?

  lastReplyAt DateTime?
  replyCount  Int       @default(0)

  isTrashed Boolean   @default(false)
  trashedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, campaignId])
  @@index([userId])
  @@index([campaignId])
  @@index([email])
  @@index([status])
  @@index([crmId])
  @@index([dealScore])
  @@index([isTrashed])
  @@index([folderId])
}

model EmailTemplate {
  id String @id @default(cuid())

  userId      String?
  user        User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  category    String? // Will be deprecated in favor of categories relation

  subject String
  body    String @db.Text

  // NEW: Visual enhancements
  thumbnailUrl    String? // Template preview image
  previewImageUrl String? // Full template visualization
  colorScheme     Json? // { primary: "#...", secondary: "#...", accent: "#..." }

  // NEW: Industry & advanced categorization
  industry String? // "saas", "ecommerce", "real_estate", "recruiting", "healthcare", "finance", "education", "nonprofit", "technology", "consulting"
  tags     String[] @default([]) // ["b2b", "enterprise", "follow-up", "cold-outreach"]

  // NEW: Template type & structure
  isSystemTemplate Boolean      @default(false) // Built-in vs user-created
  templateType     TemplateType @default(TEXT) // TEXT, VISUAL, HTML

  // NEW: Drag-and-drop editor data
  editorBlocks  Json? // Block-based editor structure with blocks array
  editorVersion String? @default("1.0")

  // NEW: AI generation metadata
  aiGenerated    Boolean @default(false)
  basePrompt     String? @db.Text // Original prompt used to generate
  aiModel        String? // Model used (e.g., "gpt-4", "claude-3")
  aiPrompt       String? @db.Text // Full prompt with context
  aiGenerationId String? // Track generation session

  // Template variables (existing but enhanced)
  variables Json? // [{ name: "company", required: true, defaultValue: "", description: "" }]

  // NEW: Enhanced stats and engagement
  timesUsed      Int       @default(0)
  avgOpenRate    Float?
  avgReplyRate   Float?
  lastUsedAt     DateTime?
  isFavorite     Boolean   @default(false)
  viewCount      Int       @default(0)
  duplicateCount Int       @default(0) // How many times it's been duplicated

  // NEW: Template categories (many-to-many)
  templateCategories TemplateInCategory[]

  // Existing relationships
  emailSequences EmailSequence[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  TemplateBlock TemplateBlock[]

  @@index([userId])
  @@index([category])
  @@index([industry])
  @@index([isSystemTemplate])
  @@index([isFavorite])
  @@index([templateType])
  @@index([timesUsed])
}

model EmailSequence {
  id         String        @id @default(cuid())
  campaignId String
  campaign   Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  templateId String
  template   EmailTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  stepNumber Int // 1, 2, 3, etc.
  delayDays  Int @default(2) // Days after previous email

  // Conditions
  sendOnlyIfNotReplied Boolean @default(true)
  sendOnlyIfNotOpened  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([campaignId, stepNumber])
  @@index([campaignId])
}

model EmailLog {
  id         String   @id @default(cuid())
  prospectId String
  prospect   Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  // Email details
  subject   String
  body      String @db.Text
  fromEmail String
  toEmail   String

  // Status
  status      EmailStatus @default(QUEUED)
  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  repliedAt   DateTime?
  bouncedAt   DateTime?

  // Tracking
  opens      Int     @default(0)
  clicks     Int     @default(0)
  trackingId String? @unique

  recipientTimezone   String?
  sentInBusinessHours Boolean @default(false)

  variant      String? // "A", "B", "C" for A/B testing
  variantGroup String? // Group ID for related variants

  // Error handling
  errorMessage String?
  retryCount   Int     @default(0)

  // Provider info
  provider   String? // "resend", "gmail", "outlook"
  providerId String? // External ID from email provider

  sendingAccountId String?
  sendingAccount   SendingAccount? @relation(fields: [sendingAccountId], references: [id], onDelete: SetNull)

  validationId String?
  validation   EmailValidationResult? @relation(fields: [validationId], references: [id], onDelete: SetNull)

  bounces EmailBounce[]
  replies EmailReply[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([prospectId])
  @@index([status])
  @@index([sentAt])
  @@index([sendingAccountId])
  @@index([variantGroup])
}

model Integration {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type IntegrationType
  name String

  // Credentials (encrypted)
  credentials Json // Encrypted API keys, tokens, etc.

  // Status
  isActive     Boolean   @default(true)
  lastSyncedAt DateTime?

  // Settings
  settings Json? // Provider-specific settings

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, type])
  @@index([userId])
}

model Analytics {
  id         String   @id @default(cuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  date DateTime @default(now())

  // Daily metrics
  emailsSent      Int @default(0)
  emailsDelivered Int @default(0)
  emailsOpened    Int @default(0)
  emailsClicked   Int @default(0)
  emailsReplied   Int @default(0)
  emailsBounced   Int @default(0)

  // Calculated rates
  deliveryRate Float?
  openRate     Float?
  clickRate    Float?
  replyRate    Float?
  bounceRate   Float?

  createdAt DateTime @default(now())

  @@unique([campaignId, date])
  @@index([campaignId])
  @@index([date])
}

model AuditLog {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  action     String // "campaign.created", "prospect.imported", etc.
  entityType String // "campaign", "prospect", "template"
  entityId   String?

  metadata  Json? // Additional context
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
}

model TeamMember {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  email       String
  role        TeamRole @default(MEMBER)
  permissions Json? // Granular permissions

  invitationToken  String?   @unique
  invitationExpiry DateTime?

  invitedAt  DateTime     @default(now())
  acceptedAt DateTime?
  status     InviteStatus @default(PENDING)

  invitedBy String? // User ID of inviter

  @@unique([userId, email])
  @@index([userId])
  @@index([invitationToken])
  @@index([status])
}

model Notification {
  id     String @id @default(cuid())
  userId String

  type    NotificationType
  title   String
  message String           @db.Text

  // Related entity
  entityType String? // "campaign", "prospect", "email"
  entityId   String?

  // Status
  read   Boolean   @default(false)
  readAt DateTime?

  // Metadata
  metadata  Json? // Additional context
  actionUrl String? // Link to related page

  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model ApiKey {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  key       String @unique // Hashed API key
  keyPrefix String // First 8 chars for display (e.g., "sk_live_")

  // Permissions
  scopes Json // ["campaigns:read", "prospects:write", etc.]

  // Status
  isActive  Boolean   @default(true)
  expiresAt DateTime?

  // Usage tracking
  lastUsedAt   DateTime?
  requestCount Int       @default(0)

  // Rate limiting
  rateLimit Int @default(1000) // Requests per hour

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([key])
  @@index([keyPrefix])
}

model SendingAccount {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Account details
  name     String
  email    String
  provider String // "resend", "gmail", "outlook"

  // Credentials (encrypted)
  credentials Json // API keys, OAuth tokens, etc.

  // Rate limiting
  dailyLimit         Int      @default(50)
  hourlyLimit        Int      @default(10)
  emailsSentToday    Int      @default(0)
  emailsSentThisHour Int      @default(0)
  lastResetDate      DateTime @default(now())
  lastResetHour      DateTime @default(now())

  warmupEnabled    Boolean     @default(true)
  warmupStage      WarmupStage @default(NEW)
  warmupStartDate  DateTime    @default(now())
  warmupDailyLimit Int         @default(20)
  warmupProgress   Int         @default(0) // Days in current stage

  peerWarmupEnabled Boolean @default(false) // Enabled for stages WARM+
  peerWarmupOptIn   Boolean @default(false) // User opted into peer network

  isActive          Boolean   @default(true)
  healthScore       Int       @default(100) // 0-100
  bounceRate        Float     @default(0)
  spamComplaintRate Float     @default(0)
  replyRate         Float     @default(0)
  openRate          Float     @default(0)
  lastHealthCheck   DateTime?
  pausedReason      String?
  pausedAt          DateTime?

  rotatedAt     DateTime? // Last time account was rotated due to health issues
  rotationCount Int       @default(0) // Number of times account has been rotated

  domainReputation Json? // SPF, DKIM, DMARC status
  lastDomainCheck  DateTime?
  blacklistStatus  Json? // Blacklist check results

  domainId String?
  domain   Domain? @relation(fields: [domainId], references: [id])

  // Relationships
  emailLogs      EmailLog[]
  schedules      SendingSchedule[]
  bounces        EmailBounce[]
  replies        EmailReply[]
  warmupSessions WarmupSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, email])
  @@index([userId])
  @@index([isActive])
  @@index([healthScore])
  @@index([domainId])
  @@index([peerWarmupEnabled])
}

model EmailBounce {
  id         String   @id @default(cuid())
  emailLogId String
  emailLog   EmailLog @relation(fields: [emailLogId], references: [id], onDelete: Cascade)

  sendingAccountId String
  sendingAccount   SendingAccount @relation(fields: [sendingAccountId], references: [id], onDelete: Cascade)

  bounceType     BounceType // HARD, SOFT, COMPLAINT
  bounceReason   String?
  diagnosticCode String?

  recipientEmail String
  bouncedAt      DateTime @default(now())

  @@index([sendingAccountId])
  @@index([bounceType])
  @@index([bouncedAt])
}

model EmailReply {
  id         String   @id @default(cuid())
  emailLogId String
  emailLog   EmailLog @relation(fields: [emailLogId], references: [id], onDelete: Cascade)

  sendingAccountId String?
  sendingAccount   SendingAccount? @relation(fields: [sendingAccountId], references: [id], onDelete: SetNull)

  prospectId String
  prospect   Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  // Reply content
  subject   String
  body      String @db.Text
  fromEmail String

  // AI analysis
  sentiment   ReplySentiment?
  category    ReplyCategory?
  isAutoReply Boolean         @default(false)

  isRead     Boolean   @default(false)
  snoozedUntil DateTime? 
  readAt     DateTime?
  isArchived Boolean   @default(false)
  archivedAt DateTime?

  isStarred Boolean   @default(false)
  starredAt DateTime?
  notes     String?   @db.Text

  // Actions taken
  campaignPaused  Boolean @default(false)
  prospectUpdated Boolean @default(false)

  repliedAt  DateTime  @default(now())
  analyzedAt DateTime?

  attachments EmailAttachment[]

  @@index([prospectId])
  @@index([campaignId])
  @@index([sentiment])
  @@index([repliedAt])
  @@index([isRead])
  @@index([isArchived])
  @@index([isStarred])
}

model EmailValidationResult {
  id     String @id @default(cuid())
  userId String

  // Email content
  subject        String
  body           String @db.Text
  recipientEmail String

  // Validation scores (0-100)
  overallScore         Int
  spamScore            Int
  personalizationScore Int
  deliverabilityScore  Int

  // Detailed analysis
  spamTriggers           Json // Array of detected spam triggers
  missingPersonalization Json // Array of missing personalization opportunities
  recommendations        Json // Array of improvement suggestions

  // Metadata
  validatedAt DateTime @default(now())

  // Relationships
  emailLogs EmailLog[]

  @@index([userId])
  @@index([overallScore])
  @@index([validatedAt])
}

model SendingSchedule {
  id     String @id @default(cuid())
  userId String

  // Email details
  prospectId String
  prospect   Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  campaignId String?

  subject String
  body    String @db.Text

  // Scheduling
  scheduledFor        DateTime
  timezone            String   @default("America/New_York")
  sendInBusinessHours Boolean  @default(true)

  // Account assignment
  sendingAccountId String?
  sendingAccount   SendingAccount? @relation(fields: [sendingAccountId], references: [id], onDelete: SetNull)

  // Status
  status      ScheduleStatus @default(PENDING)
  processedAt DateTime?
  emailLogId  String?

  // Error handling
  errorMessage String?
  retryCount   Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([scheduledFor])
  @@index([status])
  @@index([sendingAccountId])
}

model CreditTransaction {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type       CreditTransactionType
  creditType CreditType // EMAIL or RESEARCH
  amount     Int // Positive for additions, negative for deductions
  balance    Int // Balance after transaction

  // Context
  description String
  entityType  String? // "email", "research", "campaign"
  entityId    String?

  metadata Json? // Additional context

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

model CreditPurchase {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  packageId   String // "email_1000", "research_100", etc.
  packageName String

  creditType   CreditType
  creditAmount Int

  // Payment
  amount   Int // Amount in cents
  currency String @default("usd")

  stripePaymentIntentId String? @unique
  stripeSessionId       String? @unique

  status PurchaseStatus @default(PENDING)

  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Domain {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Domain details
  domain     String // e.g., mail.company.com
  recordType String @default("subdomain") // "subdomain" or "main"

  // ADD THESE TWO FIELDS:
  emailProviderId String? // "resend", "gmail", "outlook", "custom", etc.
  dkimSelector    String? // DKIM selector (e.g., "default", "k1", "selector1")

  // DNS Records
  dnsRecords Json? // { spf: {...}, dkim: {...}, dmarc: {...} }

  // ... rest of your existing fields remain the same
  isVerified            Boolean   @default(false)
  verifiedAt            DateTime?
  verificationAttempts  Int       @default(0)
  lastVerificationCheck DateTime?

  // Health status
  healthScore          Int                   @default(100)
  deliverabilityHealth DeliverabilityHealth?

  lastHealthCheck DateTime?

  // Blacklist status
  isBlacklisted    Boolean   @default(false)
  blacklistedOn    String[]  @default([])
  blacklistCheckAt DateTime?

  // Bounce tracking
  bounceRate        Float @default(0)
  spamComplaintRate Float @default(0)

  // Associated sending accounts
  sendingAccounts SendingAccount[]

  // Status
  isActive     Boolean   @default(true)
  pausedReason String?
  pausedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, domain])
  @@index([userId])
  @@index([isVerified])
  @@index([isBlacklisted])
  @@index([healthScore])
  @@index([emailProviderId]) // Add index for faster queries
}

model DeliverabilityHealth {
  id       String @id @default(cuid())
  domainId String @unique
  domain   Domain @relation(fields: [domainId], references: [id], onDelete: Cascade)

  // DNS Status
  spfStatus DNSStatus @default(UNKNOWN)
  spfValid  Boolean   @default(false)
  spfRecord String?

  dkimStatus    DNSStatus @default(UNKNOWN)
  dkimValid     Boolean   @default(false)
  dkimSelector  String? // Added single dkimSelector field
  dkimSelectors Json? // Array of DKIM selectors

  dmarcStatus DNSStatus @default(UNKNOWN)
  dmarcValid  Boolean   @default(false)
  dmarcPolicy String?
  dmarcRecord String? // Full DMARC DNS record value

  mxRecordsValid Boolean @default(false)
  mxRecords      Json?

  blacklists String[] @default([]) // Added blacklists field

  // Reputation metrics
  senderReputation  Int @default(0) // 0-100
  gmailReputation   Int @default(0)
  outlookReputation Int @default(0)

  // Engagement metrics (last 30 days)
  avgDeliveryRate      Float?
  avgOpenRate          Float?
  avgClickRate         Float?
  avgReplyRate         Float?
  avgBounceRate        Float?
  avgSpamComplaintRate Float?

  // Alerts
  hasIssues    Boolean    @default(false)
  alertLevel   AlertLevel @default(NONE) // NONE, WARNING, CRITICAL
  alertMessage String?

  // Last checks
  lastFullCheck       DateTime?
  lastReputationCheck DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([domainId])
  @@index([alertLevel])
}

model DomainVerificationRecord {
  id     String @id @default(cuid())
  userId String

  domain     String
  recordType String // "SPF", "DKIM", "DMARC"

  // Generated record
  recordName  String // DNS name
  recordValue String @db.Text // DNS value

  // Verification
  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  // ADD THIS FIELD:
  lastMessage String? // Last verification message/error

  // Metadata
  selector String? // For DKIM

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([domain])
  @@index([recordType])
}

model ProspectFolder {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name          String
  color         String @default("#3b82f6")
  icon          String @default("Folder")
  prospectCount Int    @default(0)

  isTrashed Boolean   @default(false)
  trashedAt DateTime?

  directProspects Prospect[]         @relation("ProspectToFolder")
  prospects       ProspectInFolder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isTrashed])
}

model ProspectInFolder {
  id         String         @id @default(cuid())
  prospectId String
  prospect   Prospect       @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  folderId   String
  folder     ProspectFolder @relation(fields: [folderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([prospectId, folderId])
  @@index([prospectId])
  @@index([folderId])
}

model WarmupEmail {
  id       String @id @default(cuid())
  email    String @unique
  name     String
  provider String // "gmail", "outlook", "yahoo"

  // Credentials (encrypted)
  imapHost     String
  imapPort     Int
  imapUsername String
  imapPassword String @db.Text // Encrypted

  smtpHost     String?
  smtpPort     Int?
  smtpUsername String?
  smtpPassword String? @db.Text // Encrypted

  // Health
  isActive            Boolean   @default(true)
  lastCheckAt         DateTime?
  lastEmailSentAt     DateTime?
  lastEmailReceivedAt DateTime?

  // Stats
  emailsSent     Int   @default(0)
  emailsReceived Int   @default(0)
  inboxPlacement Float @default(100) // Percentage landing in inbox vs spam

  // Rotation
  lastUsedFor   String? // Which sending account last used this
  cooldownUntil DateTime?

  // Relationships
  warmupSessions     WarmupSession[]
  warmupInteractions WarmupInteraction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([provider])
  @@index([inboxPlacement])
}

model WarmupSession {
  id               String         @id @default(cuid())
  sendingAccountId String
  sendingAccount   SendingAccount @relation(fields: [sendingAccountId], references: [id], onDelete: Cascade)

  warmupEmailId String?
  warmupEmail   WarmupEmail? @relation(fields: [warmupEmailId], references: [id], onDelete: Cascade)

  warmupType       WarmupType @default(POOL) // POOL or PEER
  peerAccountEmail String? // If PEER, the peer account email

  // Session details
  status     WarmupSessionStatus @default(ACTIVE)
  dailyLimit Int                 @default(20)

  // Stats
  emailsSent         Int   @default(0)
  emailsOpened       Int   @default(0)
  emailsReplied      Int   @default(0)
  inboxPlacementRate Float @default(0)

  // Schedule
  nextScheduledSend DateTime?
  lastSentAt        DateTime?

  startedAt DateTime  @default(now())
  endedAt   DateTime?

  interactions WarmupInteraction[]

  @@index([sendingAccountId])
  @@index([warmupEmailId])
  @@index([status])
  @@index([warmupType])
}

model WarmupInteraction {
  id        String        @id @default(cuid())
  sessionId String
  session   WarmupSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  sendingAccountId String
  warmupEmailId    String?
  warmupEmail      WarmupEmail? @relation(fields: [warmupEmailId], references: [id], onDelete: Cascade)

  // Email details
  direction WarmupDirection // OUTBOUND or INBOUND
  subject   String
  snippet   String?         @db.Text // First 100 chars of body

  // Tracking
  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  repliedAt   DateTime?

  // Inbox placement
  landedInInbox Boolean @default(true)
  landedInSpam  Boolean @default(false)

  // Email provider ID (for tracking)
  messageId String?

  isPending Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([warmupEmailId])
  @@index([direction])
  @@index([sentAt])
  @@index([isPending]) // Index for efficient pending reply queries
}

model EmailAttachment {
  id           String     @id @default(cuid())
  emailReplyId String
  emailReply   EmailReply @relation(fields: [emailReplyId], references: [id], onDelete: Cascade)

  filename    String
  contentType String // "application/pdf", "image/png", etc.
  size        Int // Size in bytes

  // Storage
  storageUrl String? // Blob storage URL
  storageKey String? // Storage identifier

  // AI analysis
  extractedText String? @db.Text // For PDFs/docs
  isContract    Boolean @default(false)
  isProposal    Boolean @default(false)
  aiSummary     String? @db.Text

  // Preview
  thumbnailUrl     String? // For images/PDFs
  previewGenerated Boolean @default(false)

  // Metadata
  analyzed   Boolean   @default(false)
  analyzedAt DateTime?

  createdAt DateTime @default(now())

  @@index([emailReplyId])
  @@index([isContract])
  @@index([isProposal])
}

model CompanySendLimit {
  id            String @id @default(cuid())
  userId        String
  companyDomain String // e.g., "google.com", "microsoft.com"

  // AI-powered limits
  dailyLimit  Int @default(2) // Max emails per day to this company
  weeklyLimit Int @default(5) // Max emails per week

  // AI learning data
  engagementScore Float     @default(0) // 0-100 based on opens, clicks, replies
  lastEngagement  DateTime?
  totalEmailsSent Int       @default(0)
  totalOpens      Int       @default(0)
  totalClicks     Int       @default(0)
  totalReplies    Int       @default(0)

  // Adaptive limits
  autoAdjust     Boolean @default(true) // AI adjusts limits based on engagement
  suggestedLimit Int? // AI's recommended limit

  // Tracking
  emailsSentToday    Int      @default(0)
  emailsSentThisWeek Int      @default(0)
  lastResetDate      DateTime @default(now())
  lastResetWeek      DateTime @default(now())

  // Company insights
  companySize        String? // "small", "medium", "large", "enterprise"
  estimatedEmployees Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, companyDomain])
  @@index([userId])
  @@index([companyDomain])
  @@index([engagementScore])
}

model SubsequenceTrigger {
  id         String   @id @default(cuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  name        String
  description String?

  // Trigger conditions (all must be true)
  conditions Json // { opened: true, clicked: false, replied: false, minOpens: 2, timeWindow: 48 }

  // Action to take
  actionType SubsequenceAction @default(SEND_EMAIL)
  templateId String?
  delayHours Int               @default(24)

  // AI optimization
  aiOptimized  Boolean @default(true)
  bestSendTime Json? // AI determines best time based on prospect activity

  // Stats
  timesTriggered Int   @default(0)
  conversionRate Float @default(0)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([campaignId])
  @@index([isActive])
}

model SequenceAutomationRule {
  id         String   @id @default(cuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  name        String
  description String?

  // Trigger definition
  triggerType     AutomationTriggerType
  triggerValue    String? // e.g., URL for link_clicked, number of days for time-based
  timeWindowHours Int? // Time window for condition evaluation

  // Conditions (optional additional filters)
  conditions Json? // { minOpens: 2, industry: "tech", etc. }

  // Actions to execute (in order)
  actions Json // Array of { type, value, delayHours }

  // Execution stats
  timesEvaluated  Int       @default(0)
  timesTriggered  Int       @default(0)
  lastTriggeredAt DateTime?

  // Status
  isActive Boolean @default(true)
  priority Int     @default(0) // Higher priority rules evaluated first

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([campaignId])
  @@index([isActive])
}

model RealtimeNotification {
  id     String @id @default(cuid())
  userId String

  type    RealtimeNotificationType
  title   String
  message String

  // Priority for smart notifications
  priority NotificationPriority @default(MEDIUM)

  // Related entity
  entityType String? // "reply", "bounce", "campaign"
  entityId   String?

  // Delivery
  delivered   Boolean   @default(false)
  deliveredAt DateTime?

  // User interaction
  read      Boolean   @default(false)
  readAt    DateTime?
  clicked   Boolean   @default(false)
  clickedAt DateTime?

  // Sound alert
  playSound   Boolean @default(false)
  soundPlayed Boolean @default(false)

  createdAt DateTime  @default(now())
  expiresAt DateTime? // Auto-delete old notifications

  @@index([userId])
  @@index([delivered])
  @@index([priority])
  @@index([createdAt])
}

// Enums
enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum SubscriptionTier {
  FREE
  STARTER
  PRO
  AGENCY
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  PAST_DUE
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum ProspectStatus {
  ACTIVE
  CONTACTED
  REPLIED
  BOUNCED
  UNSUBSCRIBED
  COMPLETED
}

enum EmailStatus {
  QUEUED
  SENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  REPLIED
  BOUNCED
  FAILED
}

enum ResearchDepth {
  BASIC
  STANDARD
  DEEP
}

enum PersonalizationLevel {
  LOW
  MEDIUM
  HIGH
  ULTRA
}

enum IntegrationType {
  GMAIL
  OUTLOOK
  RESEND
  OPENAI
  STRIPE
  HUBSPOT
  SALESFORCE
  PIPEDRIVE
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum NotificationType {
  CAMPAIGN_COMPLETED
  CAMPAIGN_PAUSED
  NEW_REPLY
  PROSPECT_IMPORTED
  EMAIL_BOUNCED
  CREDIT_LOW
  SUBSCRIPTION_EXPIRING
  TEAM_INVITE
  SYSTEM_UPDATE
}

enum ScheduleStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  CANCELLED
}

enum WarmupStage {
  NEW // 0-7 days: 20 emails/day
  WARMING // 8-14 days: 40 emails/day
  WARM // 15-21 days: 60 emails/day
  ACTIVE // 22-30 days: 80 emails/day
  ESTABLISHED // 30+ days: Full limit
}

enum BounceType {
  HARD // Permanent failure (invalid email)
  SOFT // Temporary failure (mailbox full)
  COMPLAINT // Spam complaint
}

enum ReplySentiment {
  POSITIVE // Interested, wants to learn more
  NEUTRAL // Asking questions, needs info
  NEGATIVE // Not interested, remove me
  AUTO_REPLY // Out of office, auto-responder
}

enum ReplyCategory {
  INTERESTED // Wants to schedule call/demo
  NOT_INTERESTED // Not a fit, not now
  QUESTION // Asking for more information
  OUT_OF_OFFICE // Auto-reply
  UNSUBSCRIBE // Remove from list
  REFERRAL // Forwarded to someone else
}

enum CreditTransactionType {
  PURCHASE // Bought credits
  DEDUCTION // Used credits
  REFUND // Refunded credits
  BONUS // Promotional credits
  SUBSCRIPTION // Monthly subscription credits
}

enum CreditType {
  EMAIL
  RESEARCH
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum DNSStatus {
  UNKNOWN
  PENDING
  VALID
  INVALID
  MISSING
}

enum AlertLevel {
  NONE
  WARNING
  CRITICAL
}

enum WarmupSessionStatus {
  ACTIVE
  PAUSED
  COMPLETED
  FAILED
}

enum WarmupDirection {
  OUTBOUND // Sent from sending account to warmup email
  INBOUND // Sent from warmup email to sending account
}

enum WarmupType {
  POOL // Using 30-email test pool (stages NEW & WARMING)
  PEER // Using peer-to-peer network (stages WARM, ACTIVE, ESTABLISHED)
}

enum SubsequenceAction {
  SEND_EMAIL
  PAUSE_CAMPAIGN
  ADD_TAG
  UPDATE_CRM
  NOTIFY_TEAM
}

enum AutomationTriggerType {
  EMAIL_OPENED
  EMAIL_CLICKED
  LINK_CLICKED
  EMAIL_REPLIED
  NOT_OPENED
  NOT_REPLIED
  TIME_ELAPSED
  ENGAGEMENT_SCORE
}

enum RealtimeNotificationType {
  NEW_REPLY
  HOT_LEAD
  INTERESTED_PROSPECT
  QUESTION_RECEIVED
  BOUNCE_ALERT
  SPAM_COMPLAINT
  CAMPAIGN_MILESTONE
  DAILY_SUMMARY
  CAMPAIGN_PAUSED
  ACCOUNT_PAUSED
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// PRODUCTION-READY SCHEMA MIGRATION
// This file shows the changes needed for your existing schema.prisma
// Add these models and update the EmailTemplate model as shown below

// NEW: Template type enum
enum TemplateType {
  TEXT // Plain text with variables
  VISUAL // Rich visual with drag-and-drop blocks
  HTML // Custom HTML code
}

// NEW: Template categories for organization
model TemplateCategory {
  id          String  @id @default(cuid())
  name        String  @unique // "Cold Outreach", "Follow Up", "Meeting Request"
  slug        String  @unique // "cold-outreach", "follow-up", "meeting-request"
  description String?
  icon        String? // Lucide icon name: "Mail", "Calendar", "Users"
  color       String  @default("#3b82f6") // Hex color for UI
  order       Int     @default(0) // Display order

  // Industry grouping
  industry String? // Group categories by industry: "saas", "ecommerce", etc.

  // Category can have templates
  templates TemplateInCategory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([industry])
  @@index([slug])
}

// NEW: Many-to-many relationship between templates and categories
model TemplateInCategory {
  id         String           @id @default(cuid())
  templateId String
  template   EmailTemplate    @relation(fields: [templateId], references: [id], onDelete: Cascade)
  categoryId String
  category   TemplateCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([templateId, categoryId])
  @@index([templateId])
  @@index([categoryId])
}

// NEW: Block-based template building
model TemplateBlock {
  id         String        @id @default(cuid())
  templateId String
  template   EmailTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  blockType BlockType
  order     Int // Order in the template
  content   Json // Block-specific content (text, image URL, button text, etc.)
  styling   Json? // Block-specific styles (colors, fonts, spacing)

  // Configuration
  config Json? // Additional block configuration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
  @@index([order])
}

// NEW: Block types for drag-and-drop editor
enum BlockType {
  HEADER // Hero header with title and subtitle
  PARAGRAPH // Text content with rich formatting
  IMAGE // Image with optional caption
  BUTTON // Call-to-action button
  DIVIDER // Horizontal line separator
  SIGNATURE // Email signature block
  PERSONALIZATION // Dynamic personalization field {{firstName}}
  SOCIAL_LINKS // Social media icons/links
  SPACER // Vertical spacing
  COLUMNS // Multi-column layout
  LIST // Bullet or numbered list
  QUOTE // Blockquote styling
  CODE // Code snippet
}

// NEW: AI template generation history
model TemplateGenerationHistory {
  id     String @id @default(cuid())
  userId String

  // Generation details
  prompt   String  @db.Text // User's prompt
  industry String? // Selected industry
  purpose  String? // "cold-outreach", "follow-up", etc.
  tone     String? // "professional", "casual", "friendly"

  // AI response
  aiModel          String // "gpt-4", "claude-3"
  generatedName    String // AI-generated template name
  generatedSubject String
  generatedBody    String @db.Text

  // Metadata
  templateId String? // If user saved the generated template
  saved      Boolean @default(false)
  quality    Int? // 1-5 star rating from user

  // Generation context
  context Json? // Additional context like company info, recipient details

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([saved])
  @@index([createdAt])
}
